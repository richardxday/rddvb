#!/bin/sh
SRC="$1"
DST="$2"
VIDEO="${SRC%.*}.m2v"
AUDIO="${SRC%.*}.mp2"
LOGFILE="${SRC%.*}_log.txt"
SUBTITLES="${SRC%.*}.sup"
SUBTITLESDIR="`dirname "$DST"`/subs"
RES=""
ACODEC="mp3"
APARAMS=""
VCODEC="copy"
VPARAMS=""
if [ "$3" = "h264" ] ; then
	ACODEC="mp3"
	VCODEC="libx264"
	VPARAMS="-crf 18 -preset fast -tune animation"
fi
if projectx -ini /home/richard/X.ini "$SRC" ; then
	echo "List of aspect ratio switches:"
	grep -B 1 "video basics" "$LOGFILE" | grep -o -E "\([0-9]+:[0-9]+(:[0-9]+\.[0-9]+)?\)" | sed -E "s/\((.+)\)/\1/"
	STARTTIME="`grep -B 1 "video basics" "$LOGFILE" | grep -o -m 3 -E "\([0-9]+:[0-9]+:[0-9]+\.[0-9]+\)" | sed -E "s/\((.+)\)/\1/" | head -n 1`"
	test -n "$STARTTIME" || STARTTIME="00:00:00.000"
	ASPECT="`grep -B 1 "video basics" "$LOGFILE" | grep -o -m 3 -E "\([0-9]+:[0-9]+\)" | sed -E "s/\((.+)\)/\1/" | tail -n 1`"
	test -n "$ASPECT" || ASPECT="16:9"
	echo "Aspect of $SRC is $ASPECT, start time is $STARTTIME"
	avconv -i "$VIDEO" -i "$AUDIO" -aspect "$ASPECT" -ss "$STARTTIME" -acodec $ACODEC $APARAMS -vcodec $VCODEC $VPARAMS -filter:v yadif -v warning -y "$DST" 2>&1 && chmod a+rx "$DST" && RES="1"
	rm "$SUBTITLES" "$SUBTITLES.IFO"
	if [ -d "$SUBTITLESDIR" ] ; then
		mv "$SUBTITLES"* "$SUBTITLESDIR"
	else
		rm "$SUBTITLES"*
	fi
fi
rm "$VIDEO" "${SRC%.*}"*.mp2 "$LOGFILE" "$SUBTITLES" "$SUBTITLES.IFO"
test -n "$RES"
