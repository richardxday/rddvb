#!/bin/sh
SRC="$1"
DST="$2"
VIDEO="${SRC%.*}.m2v"
AUDIO="${SRC%.*}.mp2"
LOGFILE="${SRC%.*}_log.txt"
SUBTITLES="${SRC%.*}.sup"
SUBTITLESDIR="`dirname "$DST"`/subs"
RES=""
ACODEC="copy"
APARAMS=""
VCODEC="copy"
VPARAMS=""
if [ "$3" = "h264" ] ; then
	ACODEC="mp3"
	VCODEC="libx264"
	VPARAMS="-crf 18 -preset fast -tune animation"
fi
projectx -ini /home/richard/X.ini "$SRC" && avconv -i "$VIDEO" -i "$AUDIO" -acodec $ACODEC $APARAMS -vcodec $VCODEC $VPARAMS -filter:v yadif -v warning -y "$DST" 2>&1 && chmod a+rx "$DST" && RES="1"
rm "$VIDEO" "$AUDIO" "$LOGFILE" "$SUBTITLES" "$SUBTITLES.IFO"
if [ -d "$SUBTITLESDIR" ] ; then
	mv "$SUBTITLES"* "$SUBTITLESDIR"
else
	rm "$SUBTITLES"*
fi
test -n "$RES"
